---
title: "Infer Placental Cell Composition"
output: 
  rmarkdown::html_vignette:
    df_print: kable
vignette: >
  %\VignetteIndexEntry{Infer Placental Cell Composition}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

To infer cell composition on placental villi DNAm samples, we can use the reference cpgs identified in [3]. These are provided in this package as `pl_cell_cpgs_third` and `pl_cell_cpgs_first` for third trimester (term) and first trimester samples, respectively.

In this example we are using term villi DNAm data, so we first load the reference cpgs pl_cell_cpgs_third. This is a data frame of 600 cpgs, with mean methylation levels for each cell type.

```{r, message = FALSE, warning = FALSE}
# cell deconvolution packages
library(minfi) 
library(EpiDISH)

# data wrangling and plotting
library(dplyr) 
library(ggplot2) 
library(tidyr)
library(viridis)

library(planet)

# load example data
data('pl_cell_cpgs_third')
head(pl_cell_cpgs_third)
```

After our reference cpg data is loaded, we can estimate cell composition by applying either the Constrained Projection approach implemented by the R packages minfi or EpiDISH, or a non-constrained approach by EpiDish.

#### Minfi

```{r, message = FALSE, warning = FALSE}
houseman_estimates <- minfi:::projectCellType(
  pl_betas[rownames(pl_cell_cpgs_third),], 
  pl_cell_cpgs_third,
  lessThanOne = FALSE)

head(houseman_estimates)
```

#### EpiDish

```{r, message = FALSE}
# robust partial correlations
epidish_RPC <- epidish(
  beta.m = pl_betas[rownames(pl_cell_cpgs_third),],
  ref.m = pl_cell_cpgs_third,
  method = 'RPC')

# CIBERSORT
epidish_CBS <- epidish(
  beta.m = pl_betas[rownames(pl_cell_cpgs_third),],
  ref.m = pl_cell_cpgs_third,
  method = 'CBS')

# constrained projection (houseman 2012)
epidish_CP <- epidish(
  beta.m = pl_betas[rownames(pl_cell_cpgs_third),],
  ref.m = pl_cell_cpgs_third,
  method = 'CP')
```

### Compare

We can compare the different cell composition estimates.

```{r, fig.width = 6, fig.height = 8}
bind_rows(houseman_estimates %>% as.data.frame %>% mutate(algorithm = 'CP (Houseman)'),
          epidish_RPC$estF %>% as.data.frame %>% mutate(algorithm = 'RPC'),
          epidish_CBS$estF %>% as.data.frame %>% mutate(algorithm = 'CBS'),
          epidish_CP$estF %>% as.data.frame %>% mutate(algorithm = 'CP (EpiDISH)')) %>%
  mutate(sample = rep(rownames(houseman_estimates),4)) %>%
  as_tibble() %>%
  pivot_longer(cols = -c(algorithm, sample),
               names_to = 'component',
               values_to = 'estimate') %>%
  

  ggplot(aes(x = sample, y = estimate, fill = component)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~algorithm, ncol = 1) +
  scale_fill_viridis_d() +
  theme_minimal() +
  scale_y_continuous(limits = c(-0.1,1.1), breaks = c(0, 0.5, 1), labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  coord_cartesian(ylim = c(0,1)) +
  labs(x = '', fill = '')
 
```

### References

1. [Victor Yuan, Desmond Hui, Yifan Yin et al. Cell-specific Characterization of the Placental Methylome, 29 October 2020, PREPRINT (Version 3) available at Research Square](https://www.researchsquare.com/article/rs-38223/v3)